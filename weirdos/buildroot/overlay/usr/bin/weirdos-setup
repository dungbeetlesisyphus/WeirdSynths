#!/bin/bash
# ═══════════════════════════════════════════════════════════
# WeirdOS — First-boot setup wizard
# Terminal UI for configuring audio and camera
# ═══════════════════════════════════════════════════════════

CONF="/etc/weirdos/weirdos.conf"
BOLD="\033[1m"
GREEN="\033[32m"
CYAN="\033[36m"
YELLOW="\033[33m"
DIM="\033[2m"
RESET="\033[0m"

clear

echo ""
echo -e "${GREEN}${BOLD}"
echo "    ╦ ╦╔═╗╦╦═╗╔╦╗╔═╗╔═╗"
echo "    ║║║║╣ ║╠╦╝ ║║║ ║╚═╗"
echo "    ╚╩╝╚═╝╩╩╚══╩╝╚═╝╚═╝"
echo -e "${RESET}"
echo -e "${CYAN}    v0.1.0 — First-Time Setup${RESET}"
echo ""
echo -e "${DIM}    This wizard configures your WeirdOS appliance.${RESET}"
echo -e "${DIM}    Press Enter to accept defaults shown in [brackets].${RESET}"
echo ""
echo "    ─────────────────────────────────────"
echo ""

# Source existing config
source "$CONF" 2>/dev/null || true

# ── Step 1: Camera ──
echo -e "${BOLD}[1/4] Camera${RESET}"
echo ""

echo "  Detecting video devices..."
VIDEO_DEVICES=$(ls /dev/video* 2>/dev/null | tr '\n' ' ')
if [ -z "$VIDEO_DEVICES" ]; then
    echo -e "  ${YELLOW}No cameras detected. Connect a USB webcam and try again.${RESET}"
    echo "  (Continuing with default: /dev/video0)"
    VIDEO_DEVICES="/dev/video0"
fi
echo "  Found: $VIDEO_DEVICES"
echo ""

read -p "  Camera device [${CAMERA_DEVICE:-/dev/video0}]: " INPUT
CAMERA_DEVICE="${INPUT:-${CAMERA_DEVICE:-/dev/video0}}"
echo -e "  ${GREEN}✓${RESET} Camera: $CAMERA_DEVICE"
echo ""

# ── Step 2: Audio ──
echo -e "${BOLD}[2/4] Audio${RESET}"
echo ""

echo "  Detecting audio devices..."
AUDIO_DEVICES=$(aplay -l 2>/dev/null | grep "^card" | awk '{print "  card " $2 " " $3 " " $4}')
if [ -z "$AUDIO_DEVICES" ]; then
    echo -e "  ${YELLOW}No audio devices found.${RESET}"
else
    echo "$AUDIO_DEVICES"
fi
echo ""

read -p "  ALSA device [${AUDIO_DEVICE:-hw:0}]: " INPUT
AUDIO_DEVICE="${INPUT:-${AUDIO_DEVICE:-hw:0}}"

echo ""
echo "  JACK buffer size (lower = less latency, more CPU):"
echo "  Options: 64, 128, 256, 512"
read -p "  Buffer size [${JACK_BUFSIZE:-256}]: " INPUT
JACK_BUFSIZE="${INPUT:-${JACK_BUFSIZE:-256}}"

echo ""
read -p "  Sample rate [${JACK_SAMPLERATE:-48000}]: " INPUT
JACK_SAMPLERATE="${INPUT:-${JACK_SAMPLERATE:-48000}}"

echo -e "  ${GREEN}✓${RESET} Audio: $AUDIO_DEVICE @ ${JACK_SAMPLERATE}Hz / ${JACK_BUFSIZE} frames"
echo ""

# ── Step 3: Network ──
echo -e "${BOLD}[3/4] Network${RESET}"
echo ""

read -p "  mDNS hostname [${MDNS_HOSTNAME:-weirdos}]: " INPUT
MDNS_HOSTNAME="${INPUT:-${MDNS_HOSTNAME:-weirdos}}"

echo "  SSH access lets you connect remotely: ssh weird@${MDNS_HOSTNAME}.local"
read -p "  Enable SSH? [Y/n]: " INPUT
case "$INPUT" in
    n|N) SSH_ENABLED=false ;;
    *) SSH_ENABLED=true ;;
esac

echo -e "  ${GREEN}✓${RESET} Network: ${MDNS_HOSTNAME}.local, SSH: $SSH_ENABLED"
echo ""

# ── Step 4: Internet / MediaPipe ──
echo -e "${BOLD}[4/4] Dependencies${RESET}"
echo ""

echo "  WeirdOS needs MediaPipe for face tracking."
echo "  This requires an internet connection to download (~200MB)."
echo ""

read -p "  Install MediaPipe now? [Y/n]: " INPUT
INSTALL_MEDIAPIPE=true
case "$INPUT" in
    n|N) INSTALL_MEDIAPIPE=false ;;
esac

# ── Write config ──
echo ""
echo "  ─────────────────────────────────────"
echo ""
echo -e "  ${BOLD}Writing configuration...${RESET}"

cat > "$CONF" << EOF
# ═══════════════════════════════════════════════════════════
# WeirdOS v0.1.0 — System Configuration
# Generated by setup wizard on $(date)
# ═══════════════════════════════════════════════════════════

CAMERA_DEVICE="${CAMERA_DEVICE}"
CAMERA_WIDTH=640
CAMERA_HEIGHT=480
CAMERA_FPS=30

BRIDGE_PORT=9000

AUDIO_DEVICE="${AUDIO_DEVICE}"
JACK_SAMPLERATE=${JACK_SAMPLERATE}
JACK_BUFSIZE=${JACK_BUFSIZE}
JACK_PERIODS=2

DISPLAY_MODE="wayland"

SSH_ENABLED=${SSH_ENABLED}
MDNS_HOSTNAME="${MDNS_HOSTNAME}"

CPU_GOVERNOR="performance"
GPU_MEM=256
EOF

echo -e "  ${GREEN}✓${RESET} Config written to $CONF"

# ── Install MediaPipe ──
if [ "$INSTALL_MEDIAPIPE" = true ]; then
    echo ""
    echo -e "  ${BOLD}Installing MediaPipe...${RESET}"
    echo "  (This may take several minutes)"
    pip3 install mediapipe --quiet && \
        echo -e "  ${GREEN}✓${RESET} MediaPipe installed" || \
        echo -e "  ${YELLOW}⚠${RESET} MediaPipe install failed — check internet connection"
fi

# ── Done ──
echo ""
echo "  ─────────────────────────────────────"
echo ""
echo -e "  ${GREEN}${BOLD}✓ WeirdOS setup complete!${RESET}"
echo ""
echo "  Summary:"
echo "  Camera:  $CAMERA_DEVICE"
echo "  Audio:   $AUDIO_DEVICE @ ${JACK_SAMPLERATE}Hz"
echo "  Network: ${MDNS_HOSTNAME}.local"
echo ""
echo "  Run 'weirdos start' to launch, or reboot to auto-start."
echo ""

# Mark first boot as done
mkdir -p /etc/weirdos
touch /etc/weirdos/.firstboot-done
